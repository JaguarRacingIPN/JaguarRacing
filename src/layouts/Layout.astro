---
// src/layouts/Layout.astro
import { ClientRouter } from "astro:transitions";

// --- FUENTES (SELF-HOSTED) ---
import "@fontsource/montserrat/400.css";
import "@fontsource/montserrat/700.css";
import "@fontsource/montserrat/900.css";

// --- ESTILOS GLOBALES ---
import "../styles/base/variables-base.css";
import "../styles/base/typography-ui.css";
import "../styles/layout/header.css";
import "../styles/layout/footer.css";
import "../styles/base/global-utilities.css";
import "../styles/ui/widget_chat.css";
import '../styles/layout/animation.css';

// --- COMPONENTES ESTRUCTURALES (Rutas Nuevas) ---
// Ahora importamos desde las carpetas organizadas:
import Header from "../components/layout/Header.astro";
import Footer from "../components/layout/Footer.astro";
import ChatWidget from "../components/ui/ChatWidget.astro";

// Props recibidas por el layout
const { title } = Astro.props;

// URL base para producción
const siteUrl = "https://www.jaguarracing.tech";
---

<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />

		<meta name="theme-color" content="#1a1a1a" />

		{/* --- SEGURIDAD (CSP) --- */}
		<meta
			http-equiv="Content-Security-Policy"
			content="
            default-src 'self'; 
            img-src 'self' https://www.jaguarracing.tech data:;
            script-src 'self' 'unsafe-inline' 'unsafe-eval' https://va.vercel-scripts.com; 
            style-src 'self' 'unsafe-inline'; 
            font-src 'self' data:;
            connect-src 'self' https://va.vercel-scripts.com;
          "
		/>

		<link
			rel="icon"
			type="image/webp"
			href="/favicon.webp"
		/>

		<title>{title}</title>
		<meta
			name="description"
			content="Sitio oficial de Jaguar Racing, Escudería de la ESIME Azcapotzalco (IPN). Diseño y manufactura de prototipos para Baja SAE."
		/>
		<meta
			name="keywords"
			content="Jaguar Racing, IPN, ESIME Azcapotzalco, Baja SAE, SAE México, Ingeniería Mecánica, Automotriz, Prototipos, Escudería"
		/>
		<meta name="author" content="Jaguar Racing Team" />

		{/* --- OPEN GRAPH --- */}
		<meta property="og:title" content={`Jaguar Racing | ${title}`} />
		<meta
			property="og:description"
			content="Únete a la escudería oficial del IPN. Diseñamos prototipos Baja SAE. ¡Conoce nuestra tecnología y equipo!"
		/>
		<meta
			property="og:image"
			content={`${siteUrl}/img/page/JaguarLogoConocenos.webp`}
		/>
		<meta property="og:url" content={siteUrl} />
		<meta property="og:type" content="website" />

		<ClientRouter />
	</head>
	<body>
		{/* Header persistente (No recarga al navegar) */}
		<Header transition:persist />

		{/* Contenido dinámico de cada página (index, team, etc.) */}
		<slot />

		{/* Footer Global (Se agrega aquí para no repetirlo en cada página) */}
		<Footer />

		{/* Widget de Chat persistente */}
		{/* <ChatWidget transition:persist /> */}
	</body><script>
		import { initScrollAnimations } from "../scripts/scrollAnimations.js";

		let cleanupScrollFx: (() => void) | undefined;

		document.addEventListener("astro:page-load", () => {
			// Limpiar instancia anterior si existe
			if (cleanupScrollFx) {
				cleanupScrollFx();
			}

			// Inicializar y guardar función de limpieza
			cleanupScrollFx = initScrollAnimations() as () => void;
		});

		document.addEventListener("astro:before-swap", () => {
			// Cleanup antes de cambiar de página
			if (cleanupScrollFx) {
				cleanupScrollFx();
				cleanupScrollFx = undefined;
			}
		});
	</script>
</html>
