---
import { Image } from 'astro:assets';
import '../../styles/layout/hero.css'; 

const allImages = await Astro.glob('../../assets/Index/*.{jpg,JPG,jpeg,JPEG,png,PNG,webp,WEBP}');
const backgroundImages = allImages.slice(0, 6); 
---

{/* CSS CRÍTICO INLINE - OPTIMIZADO PARA LCP + CLS */}
<style>
    .hero-placeholder {
        position: relative;
        width: 100%;
        height: 100vh; 
        height: 100svh; 
        /* Placeholder color dominante para evitar CLS mientras carga la imagen */
        background-color: #0a0a0a;
        overflow: hidden;
    }
    
    .bg-slide {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    
    .bg-slide.active {
        opacity: 1;
        z-index: 2;
    }
    
    .bg-slide.first-load {
        opacity: 1 !important;
        transition: none !important;
        z-index: 5 !important;
    }
    
    .bg-image-fit {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
    }
    
    .overlay-dark {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.3) 0%,
            rgba(0, 0, 0, 0.5) 100%
        );
        pointer-events: none;
    }
</style>

<div class="hero-background-container hero-placeholder">
    <h1 class="sr-only">Jaguar Racing Escudería IPN - Inicio</h1>
    
    <div class="slideshow-wrapper">
        {backgroundImages.map((img, index) => (
            <div class={`bg-slide ${index === 0 ? 'active first-load' : ''}`}>
                <Image 
                    src={img.default} 
                    alt={`Jaguar Racing - Imagen ${index + 1}`}
                    widths={[320, 480, 640, 800, 1024, 1280, 1920]}
                    sizes="(max-width: 480px) 480px, (max-width: 768px) 768px, (max-width: 1024px) 1024px, (max-width: 1440px) 1440px, 1920px"
                    format="webp"
                    quality={index === 0 ? 70 : 60}
                    
                    class="bg-image-fit"
                    loading={index === 0 ? "eager" : "lazy"}
                    fetchpriority={index === 0 ? "high" : "low"}
                    decoding={index === 0 ? "sync" : "async"}
                />
                <div class="overlay-dark"></div>
            </div>
        ))}
    </div>
</div>

<script>
    import { initHeroSlider } from '../../scripts/heroSlider.js';
    
    let cleanupFn: (() => void) | undefined;
    
    document.addEventListener('astro:page-load', () => {
        const firstSlide = document.querySelector('.bg-slide.first-load');
        if (firstSlide) {
            setTimeout(() => {
                firstSlide.classList.remove('first-load');
            }, 100);
        }
        
        if (cleanupFn) cleanupFn();
        cleanupFn = initHeroSlider();
    });
    
    document.addEventListener('astro:before-swap', () => {
        if (cleanupFn) {
            cleanupFn();
            cleanupFn = undefined;
        }
    });
</script>