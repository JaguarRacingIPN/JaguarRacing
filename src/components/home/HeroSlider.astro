---
import { Image } from 'astro:assets';
import '../../styles/layout/hero.css'; 

const allImages = await Astro.glob('../../assets/Index/*.{jpg,JPG,jpeg,JPEG,png,PNG,webp,WEBP}');
const backgroundImages = allImages.slice(0, 5); 
---

{/* CSS CRÍTICO INLINE */}
<style>
    .hero-placeholder {
        position: relative;
        width: 100%;
        height: 100vh; 
        height: 100svh; 
        background-color: #080808;
        overflow: hidden;
    }

    .bg-slide.first-load {
        opacity: 1 !important;
        transition: none !important;
        z-index: 5 !important;
    }
</style>

<div class="hero-background-container hero-placeholder">
    <h1 class="sr-only">Jaguar Racing Escudería IPN - Inicio</h1>
    
    <div class="slideshow-wrapper">
        {backgroundImages.map((img, index) => (
            <div class={`bg-slide ${index === 0 ? 'active first-load' : ''}`}>
                <Image 
                    src={img.default} 
                    alt={`Jaguar Racing Slide ${index + 1}`}
                    widths={[360, 540, 720, 1024, 1280, 1920]}
                    sizes={`100vw`}
                    quality={65}
                    class="bg-image-fit" 
                    loading={index === 0 ? "eager" : "lazy"} 
                    fetchpriority={index === 0 ? "high" : "auto"}
                    decoding={index === 0 ? "sync" : "async"}
                />
                <div class="overlay-dark"></div>
            </div>
        ))}
    </div>
</div>

<script>
    import { initHeroSlider } from '../../scripts/heroSlider.js';
    
    let cleanupFn: (() => void) | undefined;

    document.addEventListener('astro:page-load', () => {
        const firstSlide = document.querySelector('.bg-slide.first-load');
        if(firstSlide) {
            // Un pequeño delay para asegurar que el usuario vea la primera imagen
            // antes de permitir que el CSS de transición tome el control.
            setTimeout(() => {
                firstSlide.classList.remove('first-load');
            }, 100);
        }

        if (cleanupFn) cleanupFn();
        cleanupFn = initHeroSlider();
    });

    document.addEventListener('astro:before-swap', () => {
        if (cleanupFn) {
            cleanupFn();
            cleanupFn = undefined;
        }
    });
</script>